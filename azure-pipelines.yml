trigger:
  - master

pool:
  name: LocalAgentPool-LF Finans

variables:
  buildConfiguration: 'Release'

steps:
# Installera r칛tt .NET SDK
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '5.0.x'

# Bygg projektet
- script: dotnet build TestAutomation.UnitTests/TestAutomation.UnitTests.csproj --configuration $(buildConfiguration)
  displayName: 'Bygg projektet'

# K칬r tester med TRX-logger
- script: dotnet test TestAutomation.UnitTests/TestAutomation.UnitTests.csproj --logger:"trx"
  displayName: 'K칬r tester'

# Publicera testresultat
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/*.trx'
    mergeTestResults: true
    failTaskOnFailedTests: true

# Lista inneh친llet i allure-results f칬r fels칬kning
- task: PowerShell@2
  displayName: 'Visa inneh친ll i allure-results'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "Inneh친ll i allure-results:"
      Get-ChildItem -Path "$(System.DefaultWorkingDirectory)\TestAutomation.UnitTests\bin\$(buildConfiguration)\net5.0\allure-results" -Recurse

# Installera Allure CLI
- task: PowerShell@2
  displayName: 'Installera Allure CLI'
  inputs:
    targetType: 'inline'
    script: |
      npm install -g allure-commandline

# Generera Allure-rapport
- task: PowerShell@2
  displayName: 'Generera Allure-rapport'
  inputs:
    targetType: 'inline'
    script: |
      $ErrorActionPreference = 'Stop'
      allure generate "$(System.DefaultWorkingDirectory)\TestAutomation.UnitTests\bin\$(buildConfiguration)\net5.0\allure-results" --clean -o "$(Build.ArtifactStagingDirectory)\allure-report"

# Visa inneh친ll i rapportkatalogen f칬re publicering
- task: PowerShell@2
  displayName: 'Visa inneh친ll i allure-report'
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "Inneh친ll i allure-report:"
      Get-ChildItem -Path "$(Build.ArtifactStagingDirectory)\allure-report" -Recurse

# Publicera Allure-rapport som artifact (valfritt)
- task: PublishBuildArtifacts@1
  displayName: 'Publicera Allure-rapport som artifact'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)\allure-report'
    ArtifactName: 'AllureReport'
    publishLocation: 'Container'

# 游댏 Publicera till GitHub Pages (kr칛ver GITHUB_PAT som secret pipeline variable)
- task: PowerShell@2
  displayName: 'Publicera Allure-rapport till GitHub Pages'
  inputs:
    targetType: 'inline'
    script: |
      git config --global user.email "rezaac@hotmail.com"
      git config --global user.name "refa61"

      git clone https://$(GITHUB_PAT)@github.com/ refa61/LFFinansAutomation.git gh-pages-temp
      cd gh-pages-temp
      git checkout gh-pages

      Remove-Item * -Recurse -Force
      Copy-Item "$(Build.ArtifactStagingDirectory)\allure-report\*" -Destination "." -Recurse

      git add .
      git commit -m "Uppdaterad Allure-rapport fr친n build $(Build.BuildId)"
      git push origin gh-pages
