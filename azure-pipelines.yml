trigger:
  - master

pool:
  name: LocalAgentPool-LF Finans

variables:
  buildConfiguration: 'Release'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '5.0.x'

- script: dotnet build TestAutomation.UnitTests/TestAutomation.UnitTests.csproj --configuration $(buildConfiguration)
  displayName: 'Bygg projektet'

- script: dotnet test TestAutomation.UnitTests/TestAutomation.UnitTests.csproj --logger:"trx"
  displayName: 'K칬r tester'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/*.trx'
    mergeTestResults: true
    failTaskOnFailedTests: true

# 游빍 Steg: Visa inneh친ll i allure-results
- task: PowerShell@2
  displayName: 'Lista inneh친ll i allure-results'
  inputs:
    targetType: 'inline'
    script: |
      Get-ChildItem -Path "$(System.DefaultWorkingDirectory)\TestAutomation.UnitTests\bin\$(buildConfiguration)\net5.0\allure-results" -Recurse

- task: PowerShell@2
  displayName: 'Installera Allure CLI'
  inputs:
    targetType: 'inline'
    script: |
      npm install -g allure-commandline

- task: PowerShell@2
  displayName: 'Generera Allure-rapport'
  inputs:
    targetType: 'inline'
    script: |
      allure generate "$(System.DefaultWorkingDirectory)\TestAutomation.UnitTests\bin\$(buildConfiguration)\net5.0\allure-results" --clean -o "$(Build.ArtifactStagingDirectory)\allure-report"
  errorActionPreference: 'stop'

# 游빍 Steg: Visa inneh친ll i allure-report innan publicering
- task: PowerShell@2
  displayName: 'Visa inneh친ll i allure-report'
  inputs:
    targetType: 'inline'
    script: |
      Get-ChildItem -Path "$(Build.ArtifactStagingDirectory)\allure-report" -Recurse

- task: PublishBuildArtifacts@1
  displayName: 'Publicera Allure-rapport som artifact'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)\allure-report'
    ArtifactName: 'AllureReport'
    publishLocation: 'Container'
